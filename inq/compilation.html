<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2. Compilation and installation &mdash; INQ 0.95 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/lammps.css" type="text/css" />
    <link rel="shortcut icon" href="_static/inq_favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js?v=1c4172e4"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="3. Theory" href="theory.html" />
    <link rel="prev" title="1. README" href="introduction.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html">
            
              <img src="_static/inq_logo.png" class="logo" alt="Logo"/>
          </a>
            <div class="lammps_version">Version: <b></b></div>
            <div class="lammps_release">git info: 0.95</div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">1. README</a><ul>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#components">1.1. Components</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#basic-installation">1.2. Basic installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#reference">1.3. Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#introductory-material">1.4. Introductory material</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#release-information">1.5. Release information</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#acknowledgment">1.6. Acknowledgment</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">2. Compilation and installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#compiling-and-running-on-a-local-computer">2.1. Compiling and running on a local computer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#install-dependencies-and-setup-environment">2.1.1. Install dependencies and setup environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#clone-repository">2.1.2. Clone repository</a></li>
<li class="toctree-l3"><a class="reference internal" href="#for-cpu-only-system">2.1.3. For CPU-only system</a></li>
<li class="toctree-l3"><a class="reference internal" href="#for-an-nvidia-gpu-system-with-nvcc-11-x">2.1.4. For an Nvidia-GPU system (with NVCC 11.x)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#specific-computers">2.1.5. Specific computers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#manually-setting-utilization-of-multiple-gpu-with-mpi">2.1.6. Manually setting utilization of multiple GPU with MPI</a></li>
<li class="toctree-l3"><a class="reference internal" href="#installing-gcc-for-cuda">2.1.7. Installing GCC for CUDA</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mac-os-14">2.1.8. Mac OS 14</a></li>
<li class="toctree-l3"><a class="reference internal" href="#recover-from-nvidia-device-error">2.1.9. Recover from Nvidia device error</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#compiling-inq-on-supercomputing-clusters">2.2. Compiling INQ on Supercomputing Clusters</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#compiling-on-perlmutter-at-nersc">2.2.1. Compiling on Perlmutter at NERSC</a></li>
<li class="toctree-l3"><a class="reference internal" href="#compiling-on-lbnl-generic-linux-supercluster">2.2.2. Compiling on LBNL Generic Linux Supercluster</a></li>
<li class="toctree-l3"><a class="reference internal" href="#compiling-on-frontera-at-tacc-fhj-9-26-22">2.2.3. Compiling on Frontera at TACC (FHJ, 9/26/22)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#running-test-jobs">Running test jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#compiling-and-running-on-frontier">Compiling and running on Frontier</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#alcf-polaris">2.2.4. ALCF Polaris</a></li>
<li class="toctree-l3"><a class="reference internal" href="#llnl-sierra-lassen">2.2.5. LLNL Sierra/Lassen</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#environment">Environment</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuration">Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#build-install-and-test">Build, Install and Test</a></li>
<li class="toctree-l4"><a class="reference internal" href="#open-a-shell-in-a-node">Open a shell in a node</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-interactively">Running interactively</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#llnl-tioga-amd">2.2.6. LLNL Tioga (AMD)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#olcf-frontier-amd">2.2.7. OLCF Frontier (AMD)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#nersc-perlmutter-nvidia">2.2.8. NERSC Perlmutter (NVIDIA)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#quartz">2.2.9. Quartz</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#environment">Environment</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuration">Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#build-install-and-test">Build, Install and Test</a></li>
<li class="toctree-l4"><a class="reference internal" href="#open-a-shell-in-a-node">Open a shell in a node</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-interactively">Running interactively</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#compiling-parallel-mpi-hdf5-for-inq">2.3. Compiling Parallel (MPI) HDF5 for INQ</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cmake">2.4. CMake</a></li>
<li class="toctree-l2"><a class="reference internal" href="#boost">2.5. BOOST</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#install-boost-libraries">2.5.1. Install BOOST libraries</a></li>
<li class="toctree-l3"><a class="reference internal" href="#install-boost">2.5.2. Install BOOST</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="theory.html">3. Theory</a><ul>
<li class="toctree-l2"><a class="reference internal" href="theory.html#total-energy">3.1. Total energy</a></li>
<li class="toctree-l2"><a class="reference internal" href="theory.html#pseudopotential-application">3.2. Pseudopotential application</a></li>
<li class="toctree-l2"><a class="reference internal" href="theory.html#k-points">3.3. k-points</a></li>
<li class="toctree-l2"><a class="reference internal" href="theory.html#hartree-fock-with-k-points">3.4. Hartree-Fock with k-points</a></li>
<li class="toctree-l2"><a class="reference internal" href="theory.html#electric-fields-and-gauges">3.5. Electric fields and gauges</a></li>
<li class="toctree-l2"><a class="reference internal" href="theory.html#coordinates">3.6. Coordinates</a><ul>
<li class="toctree-l3"><a class="reference internal" href="theory.html#mini-cell-circumscribing-a-sphere">3.6.1. Mini cell circumscribing a sphere</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="theory.html#preconditioner">3.7. Preconditioner</a></li>
<li class="toctree-l2"><a class="reference internal" href="theory.html#exact-factorization">3.8. Exact factorization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="theory.html#nuclear-eom">3.8.1. Nuclear EOM</a></li>
<li class="toctree-l3"><a class="reference internal" href="theory.html#electronic-equation-of-motion">3.8.2. Electronic equation of motion</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="theory.html#self-consistency-acceleration">3.9. Self-consistency acceleration</a></li>
<li class="toctree-l2"><a class="reference internal" href="theory.html#magnetization">3.10. Magnetization</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="interface.html">4. Interface</a><ul>
<li class="toctree-l2"><a class="reference internal" href="interface.html#the-cell-command">4.1. The ‘cell’ command</a></li>
<li class="toctree-l2"><a class="reference internal" href="interface.html#the-clear-command">4.2. The ‘clear’ command</a></li>
<li class="toctree-l2"><a class="reference internal" href="interface.html#the-electrons-command">4.3. The ‘electrons’ command</a></li>
<li class="toctree-l2"><a class="reference internal" href="interface.html#the-ground-state-command">4.4. The ‘ground-state’ command</a></li>
<li class="toctree-l2"><a class="reference internal" href="interface.html#the-history-command">4.5. The ‘history’ command</a></li>
<li class="toctree-l2"><a class="reference internal" href="interface.html#the-ions-command">4.6. The ‘ions’ command</a></li>
<li class="toctree-l2"><a class="reference internal" href="interface.html#the-kpoints-command">4.7. The ‘kpoints’ command</a></li>
<li class="toctree-l2"><a class="reference internal" href="interface.html#the-perturbations-command">4.8. The ‘perturbations’ command</a></li>
<li class="toctree-l2"><a class="reference internal" href="interface.html#the-real-time-command">4.9. The ‘real-time’ command</a></li>
<li class="toctree-l2"><a class="reference internal" href="interface.html#results">4.10. Results</a></li>
<li class="toctree-l2"><a class="reference internal" href="interface.html#the-results-ground-state-command">4.11. The ‘results ground-state’ command</a></li>
<li class="toctree-l2"><a class="reference internal" href="interface.html#the-results-real-time-command">4.12. The ‘results real-time’ command</a></li>
<li class="toctree-l2"><a class="reference internal" href="interface.html#the-run-command">4.13. The ‘run’ command</a></li>
<li class="toctree-l2"><a class="reference internal" href="interface.html#the-species-command">4.14. The ‘species’ command</a></li>
<li class="toctree-l2"><a class="reference internal" href="interface.html#the-spectrum-command">4.15. The ‘spectrum’ command</a></li>
<li class="toctree-l2"><a class="reference internal" href="interface.html#the-status-command">4.16. The ‘status’ command</a></li>
<li class="toctree-l2"><a class="reference internal" href="interface.html#the-theory-command">4.17. The ‘theory’ command</a></li>
<li class="toctree-l2"><a class="reference internal" href="interface.html#units-in-inq">4.18. Units in inq</a></li>
<li class="toctree-l2"><a class="reference internal" href="interface.html#the-util-command">4.19. The ‘util’ command</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_shell_python.html">5. Tutorial (Shell and Python)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="tutorial_shell_python.html#nitrogen-molecule">5.1. Nitrogen molecule</a><ul>
<li class="toctree-l3"><a class="reference internal" href="tutorial_shell_python.html#setting-up-the-run-directory">5.1.1. Setting up the run directory</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_shell_python.html#defining-the-simulation-parameters">5.1.2. Defining the simulation parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_shell_python.html#running-the-simulation">5.1.3. Running the simulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_shell_python.html#querying-the-ground-state-results">5.1.4. Querying the ground-state results</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_shell_python.html#changing-the-ion-positions">5.1.5. Changing the ion positions</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_shell_python.html#scripting-the-potential-energy-surface-of-n2">5.1.6. Scripting: the potential energy surface of N2</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_shell_python.html#benzene-optical-absorption-spectrum">5.2. Benzene optical absorption spectrum</a><ul>
<li class="toctree-l3"><a class="reference internal" href="tutorial_shell_python.html#simulation-parameters">5.2.1. Simulation parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_shell_python.html#ground-state-calculation">5.2.2. Ground state calculation</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_shell_python.html#first-time-propagation-finding-the-optimal-time-step">5.2.3. First time propagation, finding the optimal time-step</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_shell_python.html#adding-a-perturbation">5.2.4. Adding a perturbation</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_shell_python.html#defining-the-observables">5.2.5. Defining the observables</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_shell_python.html#run-the-propagation">5.2.6. Run the propagation</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_shell_python.html#analyzing-the-results-and-obtaining-the-spectrum">5.2.7. Analyzing the results and obtaining the spectrum</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_cpp.html">6. Tutorial (C++)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="tutorial_cpp.html#nitrogen-molecule">6.1. Nitrogen molecule</a><ul>
<li class="toctree-l3"><a class="reference internal" href="tutorial_cpp.html#header">6.1.1. Header</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_cpp.html#electronic-system">6.1.2. Electronic system</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_cpp.html#single-point-energy-calculation">6.1.3. Single point energy calculation</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_cpp.html#potential-energy-surface">6.1.4. Potential energy surface</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_cpp.html#finding-the-minimum-energy-advanced">6.1.5. Finding the minimum energy (advanced)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_cpp.html#hydrogen-fluoride-molecule">6.2. Hydrogen fluoride molecule</a><ul>
<li class="toctree-l3"><a class="reference internal" href="tutorial_cpp.html#partial-charges">6.2.1. Partial charges</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_cpp.html#hartee-fock">6.2.2. Hartee-Fock</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_cpp.html#parallelization">6.2.3. Parallelization</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_cpp.html#benzene-optical-absorption-spectrum">6.3. Benzene optical absorption spectrum</a><ul>
<li class="toctree-l3"><a class="reference internal" href="tutorial_cpp.html#first-time-propagation-finding-the-optimal-time-step">6.3.1. First time propagation, finding the optimal time-step</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_cpp.html#adding-a-perturbation-and-observables">6.3.2. Adding a perturbation and observables</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_cpp.html#electronic-stopping">6.4. Electronic stopping</a><ul>
<li class="toctree-l3"><a class="reference internal" href="tutorial_cpp.html#aluminum-supercell">6.4.1. Aluminum supercell</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_cpp.html#adding-a-proton">6.4.2. Adding a proton</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_cpp.html#ground-state-calculation">6.4.3. Ground state calculation</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_cpp.html#time-propagation">6.4.4. Time propagation</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_cpp.html#results">6.4.5. Results</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="developers_guide.html">7. Developers Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="developers_guide.html#repository">7.1. Repository</a></li>
<li class="toctree-l2"><a class="reference internal" href="developers_guide.html#coding">7.2. Coding</a></li>
<li class="toctree-l2"><a class="reference internal" href="developers_guide.html#debugging-code">7.3. Debugging code</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="reference_magnitude.html">inq::magnitude</a><ul>
<li class="toctree-l2"><a class="reference internal" href="reference_magnitude.html#inq-magnitude-energy">inq::magnitude::energy</a></li>
<li class="toctree-l2"><a class="reference internal" href="reference_magnitude.html#inq-magnitude-length">inq::magnitude::length</a></li>
<li class="toctree-l2"><a class="reference internal" href="reference_magnitude.html#inq-magnitude-time">inq::magnitude::time</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="reference_systems.html">inq::systems</a><ul>
<li class="toctree-l2"><a class="reference internal" href="reference_systems.html#inq-systems-cell">inq::systems::cell</a></li>
<li class="toctree-l2"><a class="reference internal" href="reference_systems.html#inq-systems-electrons">inq::systems::electrons</a></li>
<li class="toctree-l2"><a class="reference internal" href="reference_systems.html#inq-systems-ions">inq::systems::ions</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">INQ</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active"><span class="section-number">2. </span>Compilation and installation</li>
      <li class="wy-breadcrumbs-aside">
          <a href="https://gitlab.com/npneq/inq"><img src="_static/gitlab.png" width="100" alt="gitlab"> </a>
      </li>
  </ul><div class="rst-breadcrumbs-buttons" role="navigation" aria-label="Sequential page navigation">
        <a href="introduction.html" class="btn btn-neutral float-left" title="1. README" accesskey="p"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="theory.html" class="btn btn-neutral float-right" title="3. Theory" accesskey="n">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
  </div>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="compilation-and-installation">
<h1><span class="section-number">2. </span>Compilation and installation<a class="headerlink" href="#compilation-and-installation" title="Permalink to this heading"></a></h1>
<section id="compiling-and-running-on-a-local-computer">
<h2><span class="section-number">2.1. </span>Compiling and running on a local computer<a class="headerlink" href="#compiling-and-running-on-a-local-computer" title="Permalink to this heading"></a></h2>
<section id="install-dependencies-and-setup-environment">
<h3><span class="section-number">2.1.1. </span>Install dependencies and setup environment<a class="headerlink" href="#install-dependencies-and-setup-environment" title="Permalink to this heading"></a></h3>
<p>For example in Ubuntu 22.04:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>git<span class="w"> </span>cmake<span class="w"> </span>libblas-dev<span class="w"> </span>libboost-filesystem-dev<span class="w"> </span>libboost-serialization-dev<span class="w"> </span>liblapack-dev<span class="w"> </span>libopenmpi-dev<span class="w"> </span>pybind11-dev<span class="w"> </span><span class="c1"># or libmpich-dev</span>
</pre></div>
</div>
<p>For example, in Fedora 37, systemwide:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>hdf5-devel<span class="w"> </span>lapack-devel<span class="w"> </span>...
</pre></div>
</div>
<p>and for the session:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>module<span class="w"> </span>load<span class="w"> </span>mpi
</pre></div>
</div>
</section>
<section id="clone-repository">
<h3><span class="section-number">2.1.2. </span>Clone repository<a class="headerlink" href="#clone-repository" title="Permalink to this heading"></a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>--recursive<span class="w"> </span>git@gitlab.com:npneq/inq.git<span class="w">  </span><span class="c1"># or https://gitlab.com/npneq/inq.git without account</span>
<span class="nb">cd</span><span class="w"> </span>inq
</pre></div>
</div>
</section>
<section id="for-cpu-only-system">
<h3><span class="section-number">2.1.3. </span>For CPU-only system<a class="headerlink" href="#for-cpu-only-system" title="Permalink to this heading"></a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cmake<span class="w"> </span>..<span class="w"> </span>--install-prefix<span class="o">=</span><span class="nv">$HOME</span>/.local<span class="w"> </span>-DCMAKE_BUILD_TYPE<span class="o">=</span>Release
make<span class="w"> </span>-j<span class="w"> </span><span class="m">12</span>
make<span class="w"> </span>install
ctest<span class="w"> </span>-j<span class="w"> </span><span class="m">6</span><span class="w"> </span>--output-on-failure
</pre></div>
</div>
<p>If you prefer to compile with another C++ compiler, prefix the command with <code class="docutils literal notranslate"><span class="pre">CXX=clang++</span> <span class="pre">...</span></code>, for example.</p>
</section>
<section id="for-an-nvidia-gpu-system-with-nvcc-11-x">
<h3><span class="section-number">2.1.4. </span>For an Nvidia-GPU system (with NVCC 11.x)<a class="headerlink" href="#for-an-nvidia-gpu-system-with-nvcc-11-x" title="Permalink to this heading"></a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mkdir<span class="w"> </span>build.cuda<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>build.cuda
cmake<span class="w"> </span>..<span class="w"> </span>--install-prefix<span class="o">=</span><span class="nv">$HOME</span>/.local<span class="w"> </span>-DCMAKE_BUILD_TYPE<span class="o">=</span>Release<span class="w"> </span>-DCMAKE_CUDA_COMPILER<span class="o">=</span>/usr/local/cuda/bin/nvcc<span class="w"> </span>-DENABLE_CUDA<span class="o">=</span><span class="m">1</span><span class="w"> </span>-DCMAKE_CUDA_ARCHITECTURES<span class="o">=</span><span class="m">75</span><span class="w"> </span><span class="c1"># -DCMAKE_CUDA_HOST_COMPILER=g++-12.2 if necessary</span>
cmake<span class="w"> </span>--build<span class="w"> </span>.<span class="w"> </span>--parallel<span class="w"> </span><span class="m">10</span>
ctest<span class="w"> </span>-j<span class="w"> </span><span class="m">10</span><span class="w"> </span>--output-on-failure
</pre></div>
</div>
<p>For Pascal architecture 6.1, (e.g. <a class="reference external" href="https://www.techpowerup.com/gpu-specs/geforce-gtx-1060-mobile.c3016">NVIDIA GeForce GTX 1060 Mobile</a>) use <code class="docutils literal notranslate"><span class="pre">-DCMAKE_CUDA_ARCHITECTURES=61</span></code>.</p>
<p>For Volta architecture 7.2 (e.g. <a class="reference external" href="https://www.techpowerup.com/gpu-specs/quadro-gv100.c3066">Quadro GV100</a>) use <code class="docutils literal notranslate"><span class="pre">-DCMAKE_CUDA_ARCHITECTURES=72</span></code>.</p>
<p>For Turing architecture 7.5 use <code class="docutils literal notranslate"><span class="pre">-DCMAKE_CUDA_ARCHITECTURES=75</span></code>.</p>
<p>See [[Table of relevant GPU models]] for more details.</p>
</section>
<section id="specific-computers">
<h3><span class="section-number">2.1.5. </span>Specific computers<a class="headerlink" href="#specific-computers" title="Permalink to this heading"></a></h3>
<ul class="simple">
<li><p>god: <code class="docutils literal notranslate"><span class="pre">CUDACXX=/usr/local/cuda/bin/nvcc</span> <span class="pre">../configure</span> <span class="pre">--prefix=$HOME</span> <span class="pre">--enable-cuda</span> <span class="pre">--disable-debug</span> <span class="pre">-DCMAKE_CUDA_ARCHITECTURES=72</span></code></p></li>
<li><p>(2023) cuk (Ubuntu): <code class="docutils literal notranslate"><span class="pre">cmake</span> <span class="pre">..</span> <span class="pre">--install-prefix=$HOME</span> <span class="pre">-DENABLE_CUDA=1</span> <span class="pre">-DCMAKE_CUDA_ARCHITECTURES=61</span> <span class="pre">-DCMAKE_CUDA_HOST_COMPILER=g++-11</span> <span class="pre">-DCMAKE_CUDA_COMPILER_LAUNCHER=ccache</span></code></p></li>
<li><p>(2023) pro (PopOS!): <code class="docutils literal notranslate"><span class="pre">cmake</span> <span class="pre">..</span> <span class="pre">--install-prefix=$HOME</span> <span class="pre">-DENABLE_CUDA=1</span> <span class="pre">-DCMAKE_CUDA_ARCHITECTURES=75</span> <span class="pre">-DCMAKE_CUDA_HOST_COMPILER=g++-10</span> <span class="pre">-DCMAKE_CUDA_COMPILER_LAUNCHER=ccache</span></code></p></li>
<li><p>(2023) pro:</p>
<ul>
<li><p>Fedora 38: <code class="docutils literal notranslate"><span class="pre">module</span> <span class="pre">load</span> <span class="pre">mpi</span> <span class="pre">;</span> <span class="pre">cmake</span> <span class="pre">..</span> <span class="pre">--install-prefix=$HOME/.local</span> <span class="pre">-DCMAKE_BUILD_TYPE=Release</span> <span class="pre">-DCMAKE_CUDA_COMPILER=/usr/local/cuda/bin/nvcc</span> <span class="pre">-DENABLE_CUDA=1</span> <span class="pre">-DCMAKE_CUDA_ARCHITECTURES=75</span> <span class="pre">-DCMAKE_CUDA_HOST_COMPILER=g++-12.2</span></code></p></li>
<li><p>Fedora 38 CPU/MKL: <code class="docutils literal notranslate"><span class="pre">module</span> <span class="pre">load</span> <span class="pre">mpi</span> <span class="pre">;</span> <span class="pre">cmake</span> <span class="pre">..</span> <span class="pre">--install-prefix=$HOME/.local</span> <span class="pre">-DCMAKE_BUILD_TYPE=Release</span> <span class="pre">-DCMAKE_CUDA_COMPILER=/usr/local/cuda/bin/nvcc</span> <span class="pre">-DENABLE_CUDA=1</span> <span class="pre">-DCMAKE_CUDA_ARCHITECTURES=75</span> <span class="pre">-DCMAKE_CUDA_HOST_COMPILER=g++-12.2</span> <span class="pre">-DBLA_VENDOR=Intel10_64lp</span></code></p></li>
<li><p>Ubuntu 23.10 with NVHPC 23.7</p></li>
</ul>
</li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>module<span class="w"> </span>load<span class="w"> </span>/opt/nvidia/hpc_sdk/modulefiles/nvhpc/23.7
<span class="nv">CC</span><span class="o">=</span>gcc<span class="w"> </span><span class="nv">CXX</span><span class="o">=</span>g++<span class="w"> </span><span class="nv">FC</span><span class="o">=</span>gfortran<span class="w"> </span>cmake<span class="w"> </span>../<span class="w"> </span>--install-prefix<span class="o">=</span><span class="nv">$HOME</span><span class="w"> </span>-DCMAKE_BUILD_TYPE<span class="o">=</span>Release<span class="w"> </span>-DENABLE_CUDA<span class="o">=</span>yes<span class="w"> </span>-DCMAKE_CUDA_HOST_COMPILER<span class="o">=</span>g++-11<span class="w"> </span>-DCMAKE_CUDA_ARCHITECTURES<span class="o">=</span><span class="s2">&quot;70&quot;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>(2024) studiobook</p>
<ul>
<li><p>Ubuntu 24.04: <code class="docutils literal notranslate"><span class="pre">cmake</span> <span class="pre">..</span> <span class="pre">-G</span> <span class="pre">&quot;Ninja</span> <span class="pre">Multi-Config&quot;</span> <span class="pre">--install-prefix=$HOME/.local</span> <span class="pre">-DENABLE_CUDA=1</span> <span class="pre">-DCMAKE_CUDA_ARCHITECTURES=75</span> <span class="pre">--fresh</span></code></p></li>
</ul>
</li>
</ul>
</section>
<section id="manually-setting-utilization-of-multiple-gpu-with-mpi">
<h3><span class="section-number">2.1.6. </span>Manually setting utilization of multiple GPU with MPI<a class="headerlink" href="#manually-setting-utilization-of-multiple-gpu-with-mpi" title="Permalink to this heading"></a></h3>
<p>Although a professionally maintained cluster should set process-gpu affinity correctly, this is not the case for home brewed boxes with multiple GPUs.</p>
<p>See slide 53: https://on-demand.gputechconf.com/gtc/2018/presentation/s8314-multi-gpu-programming-with-mpi.pdf</p>
</section>
<section id="installing-gcc-for-cuda">
<h3><span class="section-number">2.1.7. </span>Installing GCC for CUDA<a class="headerlink" href="#installing-gcc-for-cuda" title="Permalink to this heading"></a></h3>
<p>Specific versions of CUDA requires specific versions of GCC.
For example, CUDA 12 requires at most GCC 12 (i.e. GCC 13 will not work) and CUDA 11 requires at most GCC 11.</p>
<p>If the default GCC compiler is not the correct one you can choose a different version if it is available, -DCMAKE_CUDA_HOST_COMPILER=g++-12.2
To force the utilization of newer versions of GCC pass the option -DCMAKE_CUDA_FLAGS=”–allow-unsupported-compiler”
Alternatively you can install the correct version of gcc with a package manager, or manually</p>
<p>(Fedora doesn’t provide alternative GCC compilers).
This is a recipe using Spack package manager:</p>
<p>Install Spack:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>-c<span class="w"> </span>feature.manyFiles<span class="o">=</span><span class="nb">true</span><span class="w"> </span>https://github.com/spack/spack.git
<span class="nb">source</span><span class="w"> </span>spack/share/spack/setup-env.sh
</pre></div>
</div>
<p>Install GCC from Spack</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>spack<span class="w"> </span>info<span class="w"> </span>gcc
spack<span class="w"> </span>install<span class="w"> </span>gcc@11.3.0
</pre></div>
</div>
<p>Use g++ from the spack version</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>spack<span class="w"> </span>load<span class="w"> </span>gcc@11
which<span class="w"> </span>g++
gcc<span class="w"> </span>--version
</pre></div>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>~/spack/opt/spack/linux-fedora38-skylake/gcc-13.1.1/gcc-11.3.0-4dacqeva26v3hkjuv6j7ia2wqiet5eq4/bin/g++
<span class="o">[</span>correaa@proart<span class="w"> </span>~<span class="o">]</span>$<span class="w"> </span>g++<span class="w"> </span>--version
g++<span class="w"> </span><span class="o">(</span>Spack<span class="w"> </span>GCC<span class="o">)</span><span class="w"> </span><span class="m">11</span>.3.0
</pre></div>
</div>
<p>Fedora 38 and 39 ship with GCC 13 which is not supported by CUDA 12 (that requires GCC 12).
In that case GCC can be installed from Fedora 37</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>dnf<span class="w"> </span>--releasever<span class="o">=</span><span class="m">37</span><span class="w"> </span>--installroot<span class="o">=</span>/fc37<span class="w"> </span>install<span class="w"> </span>gcc<span class="w"> </span>g++

/fc37/bin/g++<span class="w"> </span>--version

cmake<span class="w"> </span>...<span class="w"> </span>-DBoost_ROOT<span class="o">=</span>/fc37/usr<span class="w"> </span>-DCMAKE_CUDA_HOST_COMPILER<span class="o">=</span>/fc37/bin/g++<span class="w"> </span>-DCMAKE_CUDA_COMPILER<span class="o">=</span>/opt/nvidia/hpc_sdk/Linux_x86_64/2023/cuda/bin/nvcc
</pre></div>
</div>
</section>
<section id="mac-os-14">
<h3><span class="section-number">2.1.8. </span>Mac OS 14<a class="headerlink" href="#mac-os-14" title="Permalink to this heading"></a></h3>
<ul class="simple">
<li><p>In principle there is no GPU support for INQ in Mac, INQ will use the default Apple linear algebra libraries.</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>brew<span class="w"> </span>install<span class="w"> </span>cmake<span class="w"> </span>gfortran<span class="w"> </span>open-mpi<span class="w"> </span>pkg-config<span class="w"> </span>fftw<span class="w"> </span>boost<span class="w"> </span>dumpy

git<span class="w"> </span>clone<span class="w"> </span>--recursive<span class="w"> </span>git@gitlab.com:npneq/inq.git<span class="w">  </span><span class="c1"># or https://gitlab.com/npneq/inq.git</span>
<span class="nb">cd</span><span class="w"> </span>inq
mkdir<span class="w"> </span>build
cmake<span class="w"> </span>-S<span class="w"> </span>.<span class="w"> </span>-B<span class="w"> </span>build<span class="w"> </span>--install-prefix<span class="o">=</span><span class="nv">$HOME</span>

cmake<span class="w"> </span>--build<span class="w"> </span>build<span class="w"> </span>--parallel<span class="w"> </span>--target<span class="w"> </span>install
<span class="nv">OMPI_MCA_btl</span><span class="o">=</span>^tcp<span class="w"> </span>ctest<span class="w"> </span>--test-dir<span class="w"> </span>build<span class="w"> </span>--output-on-failure
</pre></div>
</div>
</section>
<section id="recover-from-nvidia-device-error">
<h3><span class="section-number">2.1.9. </span>Recover from Nvidia device error<a class="headerlink" href="#recover-from-nvidia-device-error" title="Permalink to this heading"></a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>fuser<span class="w"> </span>--kill<span class="w"> </span>/dev/nvidia-uvm
sudo<span class="w"> </span><span class="k">while</span><span class="w"> </span>fuser<span class="w"> </span>--silent<span class="w"> </span>/dev/nvidia-uvm<span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span>sleep<span class="w"> </span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="k">done</span>
sudo<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$0</span><span class="s2"> </span><span class="nv">$@</span><span class="s2">: reload nvidia_uvm&quot;</span>
sudo<span class="w"> </span>modprobe<span class="w"> </span>-r<span class="w"> </span>nvidia_uvm<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>modprobe<span class="w"> </span>nvidia_uvm
</pre></div>
</div>
</section>
</section>
<section id="compiling-inq-on-supercomputing-clusters">
<span id="supercomputers"></span><h2><span class="section-number">2.2. </span>Compiling INQ on Supercomputing Clusters<a class="headerlink" href="#compiling-inq-on-supercomputing-clusters" title="Permalink to this heading"></a></h2>
<p>Download the code:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>--recurse-submodules<span class="w"> </span>https://gitlab.com/npneq/inq.git
<span class="nb">cd</span><span class="w"> </span>inq
</pre></div>
</div>
<section id="compiling-on-perlmutter-at-nersc">
<h3><span class="section-number">2.2.1. </span>Compiling on Perlmutter at NERSC<a class="headerlink" href="#compiling-on-perlmutter-at-nersc" title="Permalink to this heading"></a></h3>
<p>See new instructions <a class="reference external" href="https://gitlab.com/npneq/inq/-/wikis/Installation-in-NERSC's-Perlmutter">here</a>.
For old instructions see page history (button above).</p>
</section>
<section id="compiling-on-lbnl-generic-linux-supercluster">
<h3><span class="section-number">2.2.2. </span>Compiling on LBNL Generic Linux Supercluster<a class="headerlink" href="#compiling-on-lbnl-generic-linux-supercluster" title="Permalink to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>git@gitlab.com:npneq/inq.git
<span class="nb">cd</span><span class="w"> </span>inq
git<span class="w"> </span>submodule<span class="w"> </span>update<span class="w"> </span>--init<span class="w"> </span>--recursive

mkdir<span class="w"> </span>build
<span class="nb">cd</span><span class="w"> </span>build

module<span class="w"> </span>load<span class="w"> </span>gcc/7.4.0<span class="w">  </span>openmpi/2.0.2-gcc<span class="w"> </span>cmake/3.17.0

Download<span class="w"> </span>and<span class="w"> </span>build<span class="w"> </span>lapack-3.9.0<span class="w"> </span>with<span class="w"> </span>blas,<span class="w"> </span>boost_1_73_0<span class="w"> </span>and<span class="w"> </span>fftw-3.3.8

Set<span class="w"> </span>environment<span class="w"> </span>variables<span class="w"> </span>BLAS_LIBRARIES,<span class="w"> </span>LAPACK_LIBRARIES,<span class="w"> </span>FFTW_ROOT<span class="w"> </span>and<span class="w"> </span>Boost_INCLUDE_DIR<span class="w"> </span>to<span class="w"> </span>point<span class="w"> </span>to<span class="w"> </span>your<span class="w"> </span><span class="nb">local</span><span class="w"> </span>install<span class="w"> </span>locations<span class="w"> </span>of<span class="w"> </span>these<span class="w"> </span>libraries

cmake<span class="w"> </span>-DBLAS_LIBRARIES<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$BLAS_LIBRARIES</span><span class="s2">&quot;</span><span class="w"> </span>-DLAPACK_LIBRARIES<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$LAPACK_LIBRARIES</span><span class="s2">&quot;</span><span class="w"> </span>-DBoost_INCLUDE_DIR<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$Boost_INCLUDE_DIR</span><span class="s2">&quot;</span><span class="w">  </span>-DCMAKE_INSTALL_PREFIX<span class="o">=</span><span class="nv">$PWD</span><span class="w"> </span>..
make
make<span class="w"> </span>install
<span class="c1">##Example script</span>
<span class="c1">#!/bin/bash</span>
module<span class="w"> </span>purge
module<span class="w"> </span>load<span class="w"> </span>gcc/7.4.0<span class="w">  </span>openmpi/2.0.2-gcc<span class="w"> </span>cmake/3.17.0
<span class="nb">export</span><span class="w"> </span><span class="nv">BLAS_LIBRARIES</span><span class="o">=</span><span class="s2">&quot;-L/global/scratch/dasc/Projects/NPNEQ/INQ_HOME/lapack-3.9.0 -lblas&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="s2">&quot;LAPACK_LIBRARIES=-L/global/scratch/dasc/Projects/NPNEQ/INQ_HOME/lapack-3.9.0 -llapack -lblas -lgfortran&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">FFTW_ROOT</span><span class="o">=</span><span class="s2">&quot;/global/scratch/dasc/Projects/NPNEQ/INQ_HOME/fftw-3.3.8&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">Boost_INCLUDE_DIR</span><span class="o">=</span><span class="s2">&quot;/global/scratch/dasc/Projects/NPNEQ/INQ_HOME/boost_1_73_0&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">PKG_CONFIG_PATH</span><span class="o">=</span><span class="nv">$PKG_CONFIG_PATH</span>:<span class="nv">$FFTW_ROOT</span>
../configure<span class="w"> </span>--prefix<span class="o">=</span>/global/scratch/dasc/Projects/NPNEQ/INQ_HOME/tv-inq/gcc7<span class="w">  </span>--pass-thru<span class="w"> </span>-DBLAS_LIBRARIES<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$BLAS_LIBRARIES</span><span class="s2">&quot;</span><span class="w"> </span>-DLAPACK_LIBRARIES<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$LAPACK_LIBRARIES</span><span class="s2">&quot;</span><span class="w"> </span>-DBoost_INCLUDE_DIR<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$Boost_INCLUDE_DIR</span><span class="s2">&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="nv">$LD_LIBRARY_PATH</span>:<span class="nv">$SCRATCH</span>/Projects/NPNEQ/INQ_HOME/boost_1_73_0/lib:<span class="nv">$SCRATCH</span>/Projects/NPNEQ/INQ_HOME/fftw-3.3.8/lib
</pre></div>
</div>
<p>###Using totalview on Lassen</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">Compile</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">debugging</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="s">&quot;-g -O0&quot;</span>
<span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="n">In</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">cpp</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">following</span><span class="w"> </span><span class="n">include</span><span class="w"> </span><span class="n">line</span><span class="o">:</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;multi/adaptors/totalview.hpp&quot;</span>
<span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">module</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="n">totalview</span>
<span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">module</span><span class="w"> </span><span class="n">disp</span><span class="w"> </span><span class="n">totalview</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">figure</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">location</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">totalview</span>
<span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">following</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">include</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">compile</span><span class="o">+</span><span class="n">link</span><span class="w"> </span><span class="n">line</span><span class="o">:</span>
<span class="n">inc</span><span class="o">++</span><span class="w"> </span><span class="o">-</span><span class="n">g</span><span class="w"> </span><span class="o">-</span><span class="n">O0</span><span class="w"> </span><span class="o">-</span><span class="n">I</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">tce</span><span class="o">/</span><span class="n">packages</span><span class="o">/</span><span class="n">totalview</span><span class="o">/</span><span class="n">toolworks</span><span class="o">/</span><span class="n">totalview</span><span class="mf">.2020.3.11</span><span class="o">/</span><span class="n">include</span><span class="w"> </span><span class="o">-</span><span class="n">I</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">tcetmp</span><span class="o">/</span><span class="n">packages</span><span class="o">/</span><span class="n">boost</span><span class="o">/</span><span class="n">boost</span><span class="mf">-1.70.0</span><span class="o">/</span><span class="n">include</span><span class="w">  </span><span class="n">nitrogen</span><span class="p">.</span><span class="n">cu</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">nitrogen_tv</span>
<span class="n">totalview</span>
<span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="n">srun</span><span class="w"> </span><span class="o">-</span><span class="n">a</span><span class="w"> </span><span class="o">-</span><span class="n">n</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">nitrogen_tv</span>
</pre></div>
</div>
</section>
<section id="compiling-on-frontera-at-tacc-fhj-9-26-22">
<h3><span class="section-number">2.2.3. </span>Compiling on Frontera at TACC (FHJ, 9/26/22)<a class="headerlink" href="#compiling-on-frontera-at-tacc-fhj-9-26-22" title="Permalink to this heading"></a></h3>
<p>(optional) get the code</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>git@gitlab.com:npneq/inq.git
<span class="nb">cd</span><span class="w"> </span>inq
git<span class="w"> </span>submodule<span class="w"> </span>init
git<span class="w"> </span>submodule<span class="w"> </span>update
mkdir<span class="w"> </span>build
<span class="nb">cd</span><span class="w"> </span>build
</pre></div>
</div>
<p>Fix this file:
Edit <code class="docutils literal notranslate"><span class="pre">../src/basis/containing_cube.hpp</span></code>, change:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">lo</span><span class="p">[</span><span class="n">idir</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">clamp</span><span class="p">(</span><span class="n">lo</span><span class="p">[</span><span class="n">idir</span><span class="p">],</span><span class="w"> </span><span class="n">grid</span><span class="p">.</span><span class="n">symmetric_range_begin</span><span class="p">(</span><span class="n">idir</span><span class="p">),</span><span class="w"> </span><span class="n">grid</span><span class="p">.</span><span class="n">symmetric_range_end</span><span class="p">(</span><span class="n">idir</span><span class="p">));</span>
<span class="n">hi</span><span class="p">[</span><span class="n">idir</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">clamp</span><span class="p">(</span><span class="n">hi</span><span class="p">[</span><span class="n">idir</span><span class="p">],</span><span class="w"> </span><span class="n">grid</span><span class="p">.</span><span class="n">symmetric_range_begin</span><span class="p">(</span><span class="n">idir</span><span class="p">),</span><span class="w"> </span><span class="n">grid</span><span class="p">.</span><span class="n">symmetric_range_end</span><span class="p">(</span><span class="n">idir</span><span class="p">));</span>
</pre></div>
</div>
<p>to</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">lo</span><span class="p">[</span><span class="n">idir</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">lo</span><span class="p">[</span><span class="n">idir</span><span class="p">],</span><span class="w"> </span><span class="n">grid</span><span class="p">.</span><span class="n">symmetric_range_begin</span><span class="p">(</span><span class="n">idir</span><span class="p">));</span>
<span class="n">lo</span><span class="p">[</span><span class="n">idir</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">lo</span><span class="p">[</span><span class="n">idir</span><span class="p">],</span><span class="w"> </span><span class="n">grid</span><span class="p">.</span><span class="n">symmetric_range_end</span><span class="w">  </span><span class="p">(</span><span class="n">idir</span><span class="p">));</span>

<span class="n">hi</span><span class="p">[</span><span class="n">idir</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">hi</span><span class="p">[</span><span class="n">idir</span><span class="p">],</span><span class="w"> </span><span class="n">grid</span><span class="p">.</span><span class="n">symmetric_range_begin</span><span class="p">(</span><span class="n">idir</span><span class="p">));</span>
<span class="n">hi</span><span class="p">[</span><span class="n">idir</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">hi</span><span class="p">[</span><span class="n">idir</span><span class="p">],</span><span class="w"> </span><span class="n">grid</span><span class="p">.</span><span class="n">symmetric_range_end</span><span class="p">(</span><span class="n">idir</span><span class="p">));</span>
</pre></div>
</div>
<p>Configure, Compile:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">module</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="n">gcc</span>
<span class="k">module</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="n">mkl</span>
<span class="k">module</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="n">fftw3</span>
<span class="k">module</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="n">mvapich2</span><span class="o">-</span><span class="n">x</span>

<span class="k">export</span><span class="w"> </span><span class="n">BLA_VENDOR</span><span class="o">=</span><span class="n">Intel10_64lp</span>
<span class="k">export</span><span class="w"> </span><span class="n">CC</span><span class="o">=</span><span class="s">&quot;$(which gcc)&quot;</span>
<span class="k">export</span><span class="w"> </span><span class="n">CXX</span><span class="o">=</span><span class="s">&quot;$(which g++)&quot;</span>
<span class="k">export</span><span class="w"> </span><span class="n">FC</span><span class="o">=</span><span class="s">&quot;$(which gfortran)&quot;</span>

<span class="p">..</span><span class="o">/</span><span class="n">configure</span><span class="w"> </span><span class="o">--</span><span class="n">prefix</span><span class="o">=</span><span class="n">$PWD</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">prefix</span><span class="o">/</span>
<span class="n">make</span><span class="w"> </span><span class="o">-</span><span class="n">j</span><span class="w"> </span><span class="mi">16</span>
<span class="n">make</span><span class="w"> </span><span class="n">install</span>
</pre></div>
</div>
<section id="running-test-jobs">
<h4>Running test jobs<a class="headerlink" href="#running-test-jobs" title="Permalink to this heading"></a></h4>
<p>Request interactive node: <code class="docutils literal notranslate"><span class="pre">idev</span> <span class="pre">-t</span> <span class="pre">00:30:00</span> <span class="pre">-N</span> <span class="pre">1</span> <span class="pre">-n</span> <span class="pre">56</span></code></p>
<p>Run</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">module</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="n">gcc</span>
<span class="k">module</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="n">mkl</span>
<span class="k">module</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="n">fftw3</span>
<span class="k">module</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="n">mvapich2</span><span class="o">-</span><span class="n">x</span>
<span class="n">ctest</span>
</pre></div>
</div>
</section>
<section id="compiling-and-running-on-frontier">
<h4>Compiling and running on Frontier<a class="headerlink" href="#compiling-and-running-on-frontier" title="Permalink to this heading"></a></h4>
<p><img alt="image" src="_images/frontier.png" /></p>
</section>
</section>
<section id="alcf-polaris">
<h3><span class="section-number">2.2.4. </span>ALCF Polaris<a class="headerlink" href="#alcf-polaris" title="Permalink to this heading"></a></h3>
<p><em>A. A. Correa, X. Andrade, Alvaro Mayagoitia, Abhishek Bagusetty</em> 2023</p>
<hr class="docutils" />
<p>You need your ALCF username and the OTP in the MobilePASS+ app.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ssh<span class="w"> </span>polaris.alcf.anl.gov
</pre></div>
</div>
<p>Clone the repository <em>recursively</em>, use HTTP link if you don’t have a gitlab account,</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>--recursive<span class="w"> </span>git@gitlab.com:npneq/inq.git<span class="w">  </span><span class="c1"># or https://gitlab.com/npneq/inq.git</span>
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>inq
$<span class="w"> </span>mkdir<span class="w"> </span>build.debug<span class="p">;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>build.debug
</pre></div>
</div>
<p>Load the necessary modules,</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>module<span class="w"> </span>load<span class="w"> </span>cmake<span class="w"> </span>PrgEnv-gnu<span class="w"> </span>cray-fftw<span class="w"> </span>aocl<span class="w"> </span>boost<span class="w"> </span>cray-hdf5-parallel<span class="w"> </span>cudatoolkit-standalone
</pre></div>
</div>
<p>(These modules are necessary when compiling and running any inq-based code.)</p>
<p><strong>Build the tests,</strong></p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>../configure<span class="w"> </span>--prefix<span class="o">=</span><span class="nv">$PWD</span>/../install<span class="w"> </span>--enable-cuda<span class="w"> </span>--pass-thru<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-DCMAKE_CUDA_ARCHITECTURES<span class="o">=</span><span class="m">80</span><span class="w">   </span>-DCMAKE_CUDA_FLAGS<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>CC<span class="w"> </span>--no-as-needed<span class="w"> </span>--cray-print-opts<span class="o">=</span>cflags<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-DBLA_VENDOR<span class="o">=</span>FLAME<span class="w"> </span>-DLAPACK_LIBRARIES<span class="o">=</span><span class="si">${</span><span class="nv">AOCL_ROOT</span><span class="si">}</span>/lib/libflame.so<span class="w"> </span>-DMPI_CXX_LINK_FLAGS<span class="o">=</span><span class="s1">&#39;-fopenmp&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-DNCCL_INCLUDE_DIRS<span class="o">=</span>/soft/compilers/nvhpc/Linux_x86_64/23.1/comm_libs/nccl/include<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-DNCCL_LIBRARIES<span class="o">=</span>/soft/compilers/nvhpc/Linux_x86_64/23.1/comm_libs/nccl/lib/libnccl.so
$<span class="w"> </span>make<span class="w"> </span>install<span class="w"> </span>-j<span class="w"> </span><span class="o">||</span><span class="w"> </span>make<span class="w"> </span><span class="nv">VERBOSE</span><span class="o">=</span><span class="m">1</span><span class="w">  </span><span class="c1"># 4 minutes</span>
</pre></div>
</div>
<p>Run the tests,</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>qsub<span class="w"> </span>-I<span class="w"> </span>-l<span class="w"> </span><span class="nv">walltime</span><span class="o">=</span><span class="m">0</span>:60:00<span class="w"> </span>-q<span class="w"> </span>debug<span class="w"> </span>-A<span class="w"> </span>gpu_hack<span class="w"> </span>-l<span class="w"> </span><span class="k">select</span><span class="o">=</span><span class="m">1</span>:system<span class="o">=</span>polaris<span class="w"> </span>-l<span class="w"> </span><span class="nv">place</span><span class="o">=</span>scatter<span class="w"> </span>-l<span class="w"> </span><span class="nv">filesystems</span><span class="o">=</span>home:grand:eagle
<span class="o">(</span>...wait<span class="w"> </span><span class="k">for</span><span class="w"> </span>shell<span class="o">)</span>
<span class="nb">cd</span><span class="w"> </span>inq/build.debug

module<span class="w"> </span>load<span class="w"> </span>cmake<span class="w"> </span>PrgEnv-gnu<span class="w"> </span>cray-fftw<span class="w"> </span>aocl<span class="w"> </span>boost<span class="w"> </span>cray-hdf5-parallel<span class="w"> </span>cudatoolkit-standalone
<span class="nv">NCCL_DEBUG</span><span class="o">=</span><span class="s2">&quot;WARN&quot;</span><span class="w"> </span><span class="nv">MPICH_GPU_SUPPORT_ENABLED</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">MPICH_GPU_MANAGED_MEMORY_SUPPORT_ENABLED</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">CRAY_ACCEL_TARGET</span><span class="o">=</span>nvidia80<span class="w"> </span>ctest<span class="w"> </span>--output-on-failure
</pre></div>
</div>
<p>Example output,</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="w">        </span>Start<span class="w">   </span><span class="m">1</span>:<span class="w"> </span>pseudopod::unit_tests::::detect_format
<span class="w">  </span><span class="m">1</span>/168<span class="w"> </span>Test<span class="w">   </span><span class="c1">#1: pseudopod::unit_tests::::detect_format ....................   Passed    1.39 sec</span>
<span class="w">        </span>Start<span class="w">   </span><span class="m">2</span>:<span class="w"> </span>pseudopod::unit_tests::::element
<span class="w">  </span><span class="m">2</span>/168<span class="w"> </span>Test<span class="w">   </span><span class="c1">#2: pseudopod::unit_tests::::element ..........................   Passed    0.03 sec</span>
<span class="w">        </span>Start<span class="w">   </span><span class="m">3</span>:<span class="w"> </span>pseudopod::unit_tests::::erf_range_separation
...
<span class="w">        </span>Start<span class="w"> </span><span class="m">168</span>:<span class="w"> </span>inq::speed_tests::copies
<span class="m">168</span>/168<span class="w"> </span>Test<span class="w"> </span><span class="c1">#168: inq::speed_tests::copies ..................................   Passed    0.82 sec</span>

<span class="m">100</span>%<span class="w"> </span>tests<span class="w"> </span>passed,<span class="w"> </span><span class="m">0</span><span class="w"> </span>tests<span class="w"> </span>failed<span class="w"> </span>out<span class="w"> </span>of<span class="w"> </span><span class="m">168</span>

Total<span class="w"> </span>Test<span class="w"> </span><span class="nb">time</span><span class="w"> </span><span class="o">(</span>real<span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">169</span>.00<span class="w"> </span>sec
</pre></div>
</div>
<p><strong>For benchmark and production:</strong></p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>mkdir<span class="w"> </span>~/inq/build.release<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>~/inq/build.release
$<span class="w"> </span>../configure<span class="w"> </span>--prefix<span class="o">=</span><span class="nv">$PWD</span>/../install<span class="w"> </span>--enable-cuda<span class="w"> </span>--disable-debug<span class="w"> </span>--pass-thru<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-DCMAKE_CUDA_ARCHITECTURES<span class="o">=</span><span class="m">80</span><span class="w">   </span>-DCMAKE_CUDA_FLAGS<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>CC<span class="w"> </span>--no-as-needed<span class="w"> </span>--cray-print-opts<span class="o">=</span>cflags<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-DBLA_VENDOR<span class="o">=</span>FLAME<span class="w"> </span>-DLAPACK_LIBRARIES<span class="o">=</span><span class="si">${</span><span class="nv">AOCL_ROOT</span><span class="si">}</span>/lib/libflame.so<span class="w"> </span>-DMPI_CXX_LINK_FLAGS<span class="o">=</span><span class="s1">&#39;-fopenmp&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-DNCCL_INCLUDE_DIRS<span class="o">=</span>/soft/compilers/nvhpc/Linux_x86_64/23.1/comm_libs/nccl/include<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-DNCCL_LIBRARIES<span class="o">=</span>/soft/compilers/nvhpc/Linux_x86_64/23.1/comm_libs/nccl/lib/libnccl.so
$<span class="w"> </span>make<span class="w"> </span>install<span class="w"> </span>-j<span class="w"> </span><span class="o">||</span><span class="w"> </span>make<span class="w"> </span><span class="nv">VERBOSE</span><span class="o">=</span><span class="m">1</span><span class="w">  </span><span class="c1"># 4 minutes</span>
</pre></div>
</div>
<p><strong>Example jobs script with profiling and gpu binding:</strong></p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#PBS -l select=2:system=polaris</span>
<span class="c1">#PBS -l place=scatter</span>
<span class="c1">#PBS -l walltime=01:00:00</span>
<span class="c1">#PBS -q SDL_Workshop</span>
<span class="c1">#PBS -A SDL_Workshop</span>

<span class="c1">### NO NCCL SUPPORT</span>
module<span class="w"> </span>list
<span class="nb">export</span><span class="w"> </span><span class="nv">BENCHDIR</span><span class="o">=</span>/lus/grand/projects/gpu_hack/inqprove/avazquez/inqcblas/build/benchmarks

<span class="nb">export</span><span class="w"> </span><span class="nv">MPICH_GPU_SUPPORT_ENABLED</span><span class="o">=</span><span class="m">0</span>
<span class="c1">#export CRAY_ACCEL_TARGET=nvidia80</span>

<span class="nv">NNODES</span><span class="o">=</span><span class="sb">`</span>wc<span class="w"> </span>-l<span class="w"> </span>&lt;<span class="w"> </span><span class="nv">$PBS_NODEFILE</span><span class="sb">`</span>

<span class="nv">NNODES</span><span class="o">=</span><span class="m">1</span>
<span class="nv">NRANKS_PER_NODE</span><span class="o">=</span><span class="m">4</span>
<span class="nv">NTHREADS</span><span class="o">=</span><span class="m">1</span>
<span class="nv">NTOTRANKS</span><span class="o">=</span><span class="k">$((</span><span class="w"> </span><span class="nv">NNODES</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">NRANKS_PER_NODE</span><span class="w"> </span><span class="k">))</span>

<span class="nb">echo</span><span class="w"> </span><span class="nv">$NTOTRANKS</span><span class="w"> </span><span class="nv">$NDEPTH</span>

<span class="nv">jobid</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="nv">$PBS_JOBID</span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span>-F<span class="w"> </span><span class="s2">&quot;.&quot;</span><span class="w"> </span><span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span>

<span class="nv">tsize</span><span class="o">=</span>4x4x4

<span class="c1">#### RUNNING</span>
mpiexec<span class="w">    </span>-n<span class="w"> </span><span class="si">${</span><span class="nv">NTOTRANKS</span><span class="si">}</span><span class="w"> </span>--ppn<span class="w"> </span><span class="si">${</span><span class="nv">NRANKS_PER_NODE</span><span class="si">}</span><span class="w">  </span>--cpu-bind<span class="w"> </span>list:24:16:8:0<span class="w"> </span>--env<span class="w"> </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="si">${</span><span class="nv">NTHREADS</span><span class="si">}</span><span class="w">   </span>/soft/applications/gpu_affinity.sh<span class="w">  </span><span class="si">${</span><span class="nv">BEN</span>
<span class="p">CHDIR</span><span class="si">}</span>/aluminum<span class="w"> </span>-s<span class="w"> </span><span class="si">${</span><span class="nv">tsize</span><span class="si">}</span>

<span class="c1">#### PROFILING</span>

nsys<span class="w"> </span>profile<span class="w"> </span>--stats<span class="o">=</span><span class="nb">true</span><span class="w"> </span>--trace<span class="o">=</span>cuda<span class="w"> </span>-o<span class="w"> </span>reporto-stats-cblas-<span class="si">${</span><span class="nv">tsize</span><span class="si">}</span>.%p<span class="w"> </span>mpiexec<span class="w">    </span>-n<span class="w"> </span><span class="si">${</span><span class="nv">NTOTRANKS</span><span class="si">}</span><span class="w"> </span>--ppn<span class="w"> </span><span class="si">${</span><span class="nv">NRANKS_PER_NODE</span><span class="si">}</span><span class="w">  </span>--cpu-bind<span class="w"> </span>list:24:16:8:0<span class="w"> </span>--e
nv<span class="w"> </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="si">${</span><span class="nv">NTHREADS</span><span class="si">}</span><span class="w">   </span>/soft/applications/gpu_affinity.sh<span class="w">  </span><span class="si">${</span><span class="nv">BENCHDIR</span><span class="si">}</span>/aluminum<span class="w"> </span>-s<span class="w"> </span><span class="si">${</span><span class="nv">tsize</span><span class="si">}</span>
</pre></div>
</div>
<p>Example of profiling work, from Alvaro screen:</p>
<p><img alt="image" src="_images/polaris1.png" /></p>
<p><img alt="image" src="_images/polaris2.png" /></p>
</section>
<section id="llnl-sierra-lassen">
<h3><span class="section-number">2.2.5. </span>LLNL Sierra/Lassen<a class="headerlink" href="#llnl-sierra-lassen" title="Permalink to this heading"></a></h3>
<section id="environment">
<h4>Environment<a class="headerlink" href="#environment" title="Permalink to this heading"></a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>module<span class="w"> </span>load<span class="w"> </span>cuda/11<span class="w"> </span>gcc/10<span class="w"> </span>cmake/3.23
</pre></div>
</div>
</section>
<section id="configuration">
<h4>Configuration<a class="headerlink" href="#configuration" title="Permalink to this heading"></a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>rm<span class="w"> </span>-fr<span class="w"> </span>CMakeCache.txt<span class="w">  </span>CMakeFiles
cmake<span class="w"> </span>../<span class="w"> </span>--install-prefix<span class="o">=</span><span class="nv">$HOME</span><span class="w"> </span>-DENABLE_CUDA<span class="o">=</span><span class="m">1</span><span class="w"> </span>-DCMAKE_CUDA_ARCHITECTURES<span class="o">=</span><span class="m">70</span><span class="w"> </span>-DCMAKE_CUDA_HOST_COMPILER<span class="o">=</span><span class="nv">$CXX</span>
</pre></div>
</div>
</section>
<section id="build-install-and-test">
<h4>Build, Install and Test<a class="headerlink" href="#build-install-and-test" title="Permalink to this heading"></a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make<span class="w"> </span>-j
make<span class="w"> </span>install

lalloc<span class="w"> </span><span class="m">1</span><span class="w"> </span>-qpdebug<span class="w"> </span>-W60
<span class="c1"># wait</span>
<span class="nv">INQ_EXEC_ENV</span><span class="o">=</span><span class="s1">&#39;lrun -n 1 -M &quot;-mxm&quot;&#39;</span><span class="w"> </span>ctest<span class="w"> </span>--output-on-failure
</pre></div>
</div>
</section>
<section id="open-a-shell-in-a-node">
<h4>Open a shell in a node<a class="headerlink" href="#open-a-shell-in-a-node" title="Permalink to this heading"></a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>lalloc<span class="w"> </span><span class="m">1</span><span class="w"> </span>-qpdebug<span class="w"> </span>-W60
<span class="c1">#wait for shell</span>
lrun<span class="w"> </span>-n<span class="w"> </span><span class="m">2</span><span class="w"> </span>-M<span class="w"> </span><span class="s2">&quot;-mxm&quot;</span><span class="w"> </span>./command
</pre></div>
</div>
</section>
<section id="running-interactively">
<h4>Running interactively<a class="headerlink" href="#running-interactively" title="Permalink to this heading"></a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bsub<span class="w"> </span>-nnodes<span class="w"> </span><span class="m">1</span><span class="w"> </span>-q<span class="w"> </span>pdebug<span class="w"> </span>-W<span class="w"> </span><span class="m">01</span>:00<span class="w"> </span>-I<span class="w"> </span>lrun<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="w"> </span>-M<span class="w"> </span><span class="s2">&quot;-mxm&quot;</span><span class="w"> </span>./command
</pre></div>
</div>
</section>
</section>
<section id="llnl-tioga-amd">
<h3><span class="section-number">2.2.6. </span>LLNL Tioga (AMD)<a class="headerlink" href="#llnl-tioga-amd" title="Permalink to this heading"></a></h3>
<p>https://hpc.llnl.gov/hardware/compute-platforms/tioga</p>
<p>https://lc.llnl.gov/confluence/display/ELCAPEA</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">module</span><span class="w"> </span><span class="n">reset</span>
<span class="k">module</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="n">cce</span><span class="o">/</span><span class="mf">16.0.1</span>
<span class="k">module</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="n">rocm</span><span class="o">/</span><span class="mf">5.6.0</span>
<span class="k">module</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="n">python</span><span class="o">/</span><span class="mf">3.10.8</span>

<span class="k">export</span><span class="w"> </span><span class="n">LD_LIBRARY_PATH</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">cray</span><span class="o">/</span><span class="n">pe</span><span class="o">/</span><span class="n">cce</span><span class="o">/</span><span class="mf">16.0.1</span><span class="o">/</span><span class="n">cce</span><span class="o">-</span><span class="n">clang</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/:</span><span class="n">$CRAY_LD_LIBRARY_PATH</span><span class="o">:</span><span class="n">$LD_LIBRARY_PATH</span>

<span class="n">rm</span><span class="w"> </span><span class="o">-</span><span class="n">fr</span><span class="w"> </span><span class="n">CMakeCache</span><span class="p">.</span><span class="n">txt</span><span class="w">  </span><span class="n">CMakeFiles</span>
<span class="n">cmake</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="w">  </span><span class="o">--</span><span class="n">install</span><span class="o">-</span><span class="n">prefix</span><span class="o">=</span><span class="n">$HOME</span><span class="w"> </span>\
<span class="o">-</span><span class="n">DENABLE_HIP</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span>\
<span class="o">-</span><span class="n">DCMAKE_SYSTEM_NAME</span><span class="o">=</span><span class="n">CrayLinuxEnvironment</span><span class="w"> </span>\
<span class="o">-</span><span class="n">DCMAKE_HIP_ARCHITECTURES</span><span class="o">=</span><span class="n">gfx90a</span><span class="w"> </span>\
<span class="o">-</span><span class="n">DMPI_CXX_COMPILER</span><span class="o">=</span><span class="n">$MPICH_DIR</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">mpicxx</span><span class="w"> </span>\
<span class="o">-</span><span class="n">DMPI_CXX_LINK_FLAGS</span><span class="o">=</span><span class="s">&quot;$PE_MPICH_GTL_DIR_amd_gfx90a $PE_MPICH_GTL_LIBS_amd_gfx90a&quot;</span>
</pre></div>
</div>
</section>
<section id="olcf-frontier-amd">
<h3><span class="section-number">2.2.7. </span>OLCF Frontier (AMD)<a class="headerlink" href="#olcf-frontier-amd" title="Permalink to this heading"></a></h3>
<p>You need your OLCF username and PIN + RSA token code set up to log in. Note that it can take about a month between signing up for an account and receiving your RSA token.</p>
<p>Download <code class="docutils literal notranslate"><span class="pre">inq</span></code> from the git repository if you haven’t done so:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>https://gitlab.com/npneq/inq.git
<span class="nb">cd</span><span class="w"> </span>inq
git<span class="w"> </span>submodule<span class="w"> </span>update<span class="w"> </span>--init<span class="w"> </span>--recursive
</pre></div>
</div>
<p>Load the necessary modules:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>module<span class="w"> </span>reset
module<span class="w"> </span>load<span class="w"> </span>cmake<span class="p">;</span><span class="w"> </span>module<span class="w"> </span>load<span class="w"> </span>rocm/5.6.0<span class="p">;</span><span class="w"> </span>module<span class="w"> </span>load<span class="w"> </span>cray-python<span class="p">;</span><span class="w"> </span>module<span class="w"> </span>load<span class="w"> </span>miniforge3/23.11.0-0<span class="p">;</span>
module<span class="w"> </span>load<span class="w"> </span>cray-fftw/3.3.10.3<span class="p">;</span><span class="w"> </span>module<span class="w"> </span>load<span class="w"> </span>gcc-native/12.3<span class="p">;</span><span class="w">  </span>module<span class="w"> </span>load<span class="w"> </span>boost/1.79.0<span class="p">;</span><span class="w"> </span>module<span class="w"> </span>load<span class="w"> </span>Core/24.00<span class="p">;</span><span class="w"> </span>module<span class="w"> </span>load<span class="w"> </span>openblas/0.3.17
</pre></div>
</div>
<p>Note that these versions of rocm, boost, fftw, and openblas are not the most up-to-date versions on Frontier, and may need to be updated soon. To set the correct path environment variables, you must load these modules both when compiling and running inq.</p>
<p>Configure and install with cmake:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mkdir<span class="w"> </span>build
<span class="nb">cd</span><span class="w"> </span>build
cmake<span class="w"> </span>../<span class="w"> </span>--install-prefix<span class="o">=</span><span class="nv">$PWD</span><span class="w"> </span>-DENABLE_HIP<span class="o">=</span><span class="m">1</span><span class="w"> </span>-DCMAKE_HIP_ARCHITECTURES<span class="o">=</span>gfx90a<span class="w"> </span>-DCMAKE_CXX_STANDARD<span class="o">=</span><span class="m">17</span><span class="w"> </span>-DMPI_CXX_LINK_FLAGS<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PE_MPICH_GTL_DIR_amd_gfx90a</span><span class="s2"> </span><span class="nv">$PE_MPICH_GTL_LIBS_amd_gfx90a</span><span class="s2">&quot;</span>
make<span class="w"> </span>-j<span class="w"> </span><span class="o">||</span><span class="w"> </span>make<span class="w"> </span><span class="nv">VERBOSE</span><span class="o">=</span><span class="m">1</span>
make<span class="w"> </span>install
</pre></div>
</div>
<p>Test linking for inq:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>bin/
ldd<span class="w"> </span>inq
</pre></div>
</div>
<p>and for pinq:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>python/
ldd<span class="w"> </span>_pinq.cpython-310-x86_64-linux-gnu.so
</pre></div>
</div>
<p>All links should exist, and versions, e.g. of rocm, should be consistent:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="w">        </span>libhipfft.so<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/opt/rocm-5.6.0/lib/libhipfft.so<span class="w"> </span><span class="o">(</span>0x00007f06337a2000<span class="o">)</span>
<span class="w">        </span>libhipblas.so.1<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/opt/rocm-5.6.0/lib/libhipblas.so.1<span class="w"> </span><span class="o">(</span>0x00007f0633734000<span class="o">)</span>
<span class="w">        </span>libamdhip64.so.5<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/opt/rocm-5.6.0/lib/libamdhip64.so.5<span class="w"> </span><span class="o">(</span>0x00007f063206b000<span class="o">)</span>
</pre></div>
</div>
<p>Find below a job script for running inq tests. This script can be used as a template for running inq jobs in general.</p>
<p>Set <code class="docutils literal notranslate"><span class="pre">-c=cpus_per_rs</span></code> to 7 because Frontier GPU nodes contain 8 GPUs and 64 CPUs (physical cores with 2 hardware threads each), but 8 CPUs are reserved.
Setting <code class="docutils literal notranslate"><span class="pre">stdbuf</span> <span class="pre">-o</span> <span class="pre">0</span></code> helps ensure that job outputs are written in real time.
For production runs, use <code class="docutils literal notranslate"><span class="pre">#SBATCH</span> <span class="pre">-p</span> <span class="pre">batch</span></code>.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#SBATCH -A cph169</span>
<span class="c1">#SBATCH -J inq-test</span>
<span class="c1">#SBATCH -t 00:30:00</span>
<span class="c1">#SBATCH -q debug</span>
<span class="c1">#SBATCH -N 1</span>
<span class="c1">#SBATCH --gpus-per-node 1</span>
<span class="c1">#SBATCH --ntasks-per-gpu 1</span>
<span class="c1">#SBATCH --gpu-bind closest</span>

module<span class="w"> </span>load<span class="w"> </span>cmake<span class="p">;</span><span class="w"> </span>module<span class="w"> </span>load<span class="w"> </span>rocm/5.6.0<span class="p">;</span><span class="w"> </span>module<span class="w"> </span>load<span class="w"> </span>cray-python<span class="p">;</span><span class="w"> </span>module<span class="w"> </span>load<span class="w"> </span>miniforge3/23.11.0-0<span class="p">;</span>
module<span class="w"> </span>load<span class="w"> </span>cray-fftw/3.3.10.3<span class="p">;</span><span class="w"> </span>module<span class="w"> </span>load<span class="w"> </span>gcc-native/12.3<span class="p">;</span><span class="w">  </span>module<span class="w"> </span>load<span class="w"> </span>boost/1.79.0<span class="p">;</span><span class="w"> </span>module<span class="w"> </span>load<span class="w"> </span>Core/24.00<span class="p">;</span><span class="w"> </span>module<span class="w"> </span>load<span class="w"> </span>openblas/0.3.17

<span class="nb">set</span><span class="w"> </span>-e<span class="w"> </span><span class="c1">#make the script fail if a command fails</span>
<span class="nb">set</span><span class="w"> </span>-x<span class="w"> </span><span class="c1">#output commands to the terminal</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">SLURM_CPU_BIND</span><span class="o">=</span><span class="s2">&quot;cores&quot;</span>
module<span class="w"> </span>load<span class="w"> </span>craype-accel-amd-gfx90a
<span class="nb">export</span><span class="w"> </span><span class="nv">MPICH_GPU_SUPPORT_ENABLED</span><span class="o">=</span><span class="m">1</span>

<span class="nv">INQ_EXEC_ENV</span><span class="o">=</span><span class="s2">&quot;srun -c 7 stdbuf -o 0&quot;</span><span class="w"> </span>ctest<span class="w"> </span>--output-on-failure<span class="w"> </span>--timeout<span class="w"> </span><span class="m">200</span><span class="w">  </span>-V<span class="w">  </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>ctest.sbatch.out
</pre></div>
</div>
<p>Testsuite results 12/20/2024:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">99</span>%<span class="w"> </span>tests<span class="w"> </span>passed,<span class="w"> </span><span class="m">2</span><span class="w"> </span>tests<span class="w"> </span>failed<span class="w"> </span>out<span class="w"> </span>of<span class="w"> </span><span class="m">239</span>

Total<span class="w"> </span>Test<span class="w"> </span><span class="nb">time</span><span class="w"> </span><span class="o">(</span>real<span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">942</span>.97<span class="w"> </span>sec

The<span class="w"> </span>following<span class="w"> </span>tests<span class="w"> </span>FAILED:
<span class="w">         </span><span class="m">72</span><span class="w"> </span>-<span class="w"> </span>inq::unit_tests::hamiltonian::xc_term<span class="w"> </span><span class="o">(</span>Failed<span class="o">)</span>
<span class="w">         </span><span class="m">73</span><span class="w"> </span>-<span class="w"> </span>inq::unit_tests::hamiltonian::zeeman_coupling<span class="w"> </span><span class="o">(</span>Failed<span class="o">)</span>
</pre></div>
</div>
</section>
<section id="nersc-perlmutter-nvidia">
<h3><span class="section-number">2.2.8. </span>NERSC Perlmutter (NVIDIA)<a class="headerlink" href="#nersc-perlmutter-nvidia" title="Permalink to this heading"></a></h3>
<p>Your need your NERSC username and OTP + password set up to login. (eg. from <code class="docutils literal notranslate"><span class="pre">iris.nersc.gov</span></code>)</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>ssh<span class="w"> </span>perlmutter-p1.nersc.gov
</pre></div>
</div>
<p>Now download <code class="docutils literal notranslate"><span class="pre">inq</span></code> or <code class="docutils literal notranslate"><span class="pre">inq_template</span></code> from the git repository if you haven’t done it already.</p>
<p>Load the necessary modules,</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>module<span class="w"> </span>load<span class="w"> </span>cray-fftw<span class="w"> </span>cmake
</pre></div>
</div>
<p>These modules are necessary when compiling and running any inq-based code.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mkdir<span class="w"> </span>build
<span class="nb">cd</span><span class="w"> </span>build
git<span class="w"> </span>submodule<span class="w"> </span>init
git<span class="w"> </span>submodule<span class="w"> </span>update
cmake<span class="w"> </span>../<span class="w"> </span>--install-prefix<span class="o">=</span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/../install<span class="w"> </span>-DENABLE_CUDA<span class="o">=</span><span class="m">1</span><span class="w"> </span>-DCMAKE_CUDA_ARCHITECTURES<span class="o">=</span><span class="m">80</span><span class="w">  </span>--fresh
make<span class="w"> </span>-j<span class="w"> </span><span class="o">||</span><span class="w"> </span>make<span class="w"> </span><span class="nv">VERBOSE</span><span class="o">=</span><span class="m">1</span>
make<span class="w"> </span>install
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">-DCMAKE_BUILD_TYPE=Debug</span> <span class="pre">-DCMAKE_CXX_FLAGS=&quot;-ldl</span> <span class="pre">-DBOOST_STACKTRACE_USEADDR2LINE</span> <span class="pre">-no-pie&quot;</span></code> is a cmake flag you may want to use while debugging. Errors may also be more traceable using c++ scripts or the command line interface than the python interface.</p>
<p>This should have installed the necessary files (main pseudopotentials) in the prefix directory and compiled the tests.</p>
<p>To check that the tests work, we can request an interactive session:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">unset</span><span class="w"> </span>MPICH_GPU_SUPPORT_ENABLED
salloc<span class="w"> </span>--nodes<span class="w"> </span><span class="m">1</span><span class="w"> </span>--qos<span class="w"> </span>interactive<span class="w"> </span>--gpus-per-task<span class="o">=</span><span class="m">1</span><span class="w"> </span>--time<span class="w"> </span><span class="m">00</span>:30:00<span class="w"> </span>--constraint<span class="w"> </span>gpu<span class="w"> </span>--gpus<span class="w"> </span><span class="m">4</span><span class="w"> </span>--account<span class="o">=</span>m4409
<span class="o">(</span>...wait<span class="w"> </span><span class="k">for</span><span class="w"> </span>shell<span class="o">)</span>
<span class="nv">INQ_EXEC_ENV</span><span class="o">=</span><span class="s2">&quot;srun -n 1 --gpus-per-task 1&quot;</span><span class="w"> </span>ctest<span class="w"> </span>--output-on-failure
</pre></div>
</div>
<p>If everything goes well, you will see the output:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>Test<span class="w"> </span>project<span class="w"> </span>/global/homes/c/correaa/inq/b2
<span class="w">        </span>Start<span class="w">   </span><span class="m">1</span>:<span class="w"> </span>ctest_build_test_code
<span class="w">  </span><span class="m">1</span>/145<span class="w"> </span>Test<span class="w">   </span><span class="c1">#1: ctest_build_test_code ...............................   Passed    0.24 sec</span>
<span class="w">        </span>Start<span class="w">   </span><span class="m">2</span>:<span class="w"> </span>spglibtest
<span class="w">  </span><span class="m">2</span>/145<span class="w"> </span>Test<span class="w">   </span><span class="c1">#2: spglibtest ..........................................   Passed    0.29 sec</span>
...
<span class="m">144</span>/145<span class="w"> </span>Test<span class="w"> </span><span class="c1">#144: tests::silicon_hartree_fock .........................   Passed    7.13 sec</span>
<span class="w">        </span>Start<span class="w"> </span><span class="m">145</span>:<span class="w"> </span>speed_tests::copies
<span class="m">145</span>/145<span class="w"> </span>Test<span class="w"> </span><span class="c1">#145: speed_tests::copies .................................   Passed    2.85 sec</span>

<span class="m">100</span>%<span class="w"> </span>tests<span class="w"> </span>passed,<span class="w"> </span><span class="m">0</span><span class="w"> </span>tests<span class="w"> </span>failed<span class="w"> </span>out<span class="w"> </span>of<span class="w"> </span><span class="m">145</span>

Total<span class="w"> </span>Test<span class="w"> </span><span class="nb">time</span><span class="w"> </span><span class="o">(</span>real<span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">470</span>.09<span class="w"> </span>sec
</pre></div>
</div>
<p>If you see any error, please <a class="reference external" href="https://gitlab.com/npneq/inq/-/issues">open and issue</a> and paste as much information on the error as possible.</p>
<p>In the same way, test can be submitted as a batch job.
This job script can be use as a basis for other inq-based jobs.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span>&gt;<span class="w"> </span>inq.sbatch
<span class="c1">#!/bin/bash</span>
<span class="c1">#SBATCH -A m4409</span>
<span class="c1">#SBATCH -q debug</span>
<span class="c1">#SBATCH -C gpu</span>
<span class="c1">#SBATCH -t 00:30:00</span>
<span class="c1">#SBATCH -N 1</span>
<span class="c1">#SBATCH --ntasks-per-node=1</span>
<span class="c1">#SBATCH --cpus-per-task=32</span>
<span class="c1">#SBATCH --gpus-per-task=1</span>

module<span class="w"> </span>load<span class="w"> </span>cray-fftw<span class="w"> </span>cray-hdf5<span class="w"> </span>cmake/3.24

<span class="nb">export</span><span class="w"> </span><span class="nv">SLURM_CPU_BIND</span><span class="o">=</span><span class="s2">&quot;cores&quot;</span>
<span class="c1">#export MPICH_GPU_SUPPORT_ENABLED=1  # enable CUDA-aware MPI</span>

<span class="nv">INQ_EXEC_ENV</span><span class="o">=</span><span class="s2">&quot;srun -n 1 --gpus-per-task 1&quot;</span><span class="w"> </span>ctest<span class="w"> </span>--output-on-failure<span class="w"> </span>--timeout<span class="w"> </span><span class="m">200</span><span class="w">  </span>-V<span class="w">  </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>ctest.sbatch.out
</pre></div>
</div>
<p>Submit the job</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>sbatch<span class="w"> </span>inq.sbatch
watch<span class="w"> </span>-n<span class="w"> </span><span class="m">30</span><span class="w"> </span>squeue
</pre></div>
</div>
<p>(General information to submit jobs: https://docs.nersc.gov/systems/perlmutter/running-jobs/)</p>
<p>To verify that GPUs are detected, look for line(s) like this in the output.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2023</span><span class="mo">-02-02</span><span class="w"> </span><span class="mi">12</span><span class="o">:</span><span class="mi">43</span><span class="o">:</span><span class="mf">03.320</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">electrons</span><span class="o">:</span><span class="n">SBm3gw</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">info</span><span class="p">]</span><span class="w">   </span><span class="n">process</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">gpu</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">+</span><span class="n">KNjL8WNHzx9QQ9reEfvmQ</span>
</pre></div>
</div>
<p>What is next? The easiest way to write your own inq-based program is to use <code class="docutils literal notranslate"><span class="pre">inq_template</span></code>.</p>
</section>
<section id="quartz">
<h3><span class="section-number">2.2.9. </span>Quartz<a class="headerlink" href="#quartz" title="Permalink to this heading"></a></h3>
<section id="environment">
<h4>Environment<a class="headerlink" href="#environment" title="Permalink to this heading"></a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>module<span class="w"> </span>load<span class="w"> </span>cuda/11<span class="w"> </span>gcc/10<span class="w"> </span>cmake/3.23
</pre></div>
</div>
</section>
<section id="configuration">
<h4>Configuration<a class="headerlink" href="#configuration" title="Permalink to this heading"></a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>rm<span class="w"> </span>-fr<span class="w"> </span>CMakeCache.txt<span class="w">  </span>CMakeFiles
cmake<span class="w"> </span>../<span class="w"> </span>--install-prefix<span class="o">=</span><span class="nv">$HOME</span><span class="w"> </span>-DENABLE_CUDA<span class="o">=</span><span class="m">1</span><span class="w"> </span>-DCMAKE_CUDA_ARCHITECTURES<span class="o">=</span><span class="m">70</span><span class="w"> </span>-DCMAKE_CUDA_HOST_COMPILER<span class="o">=</span><span class="nv">$CXX</span>
</pre></div>
</div>
</section>
<section id="build-install-and-test">
<h4>Build, Install and Test<a class="headerlink" href="#build-install-and-test" title="Permalink to this heading"></a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make<span class="w"> </span>-j
make<span class="w"> </span>install

lalloc<span class="w"> </span><span class="m">1</span><span class="w"> </span>-qpdebug<span class="w"> </span>-W60
<span class="c1"># wait</span>
<span class="nv">INQ_EXEC_ENV</span><span class="o">=</span><span class="s1">&#39;lrun -n 1 -M &quot;-mxm&quot;&#39;</span><span class="w"> </span>ctest<span class="w"> </span>--output-on-failure
</pre></div>
</div>
</section>
<section id="open-a-shell-in-a-node">
<h4>Open a shell in a node<a class="headerlink" href="#open-a-shell-in-a-node" title="Permalink to this heading"></a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>lalloc<span class="w"> </span><span class="m">1</span><span class="w"> </span>-qpdebug<span class="w"> </span>-W60
<span class="c1">#wait for shell</span>
lrun<span class="w"> </span>-n<span class="w"> </span><span class="m">2</span><span class="w"> </span>-M<span class="w"> </span><span class="s2">&quot;-mxm&quot;</span><span class="w"> </span>./command
</pre></div>
</div>
</section>
<section id="running-interactively">
<h4>Running interactively<a class="headerlink" href="#running-interactively" title="Permalink to this heading"></a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bsub<span class="w"> </span>-nnodes<span class="w"> </span><span class="m">1</span><span class="w"> </span>-q<span class="w"> </span>pdebug<span class="w"> </span>-W<span class="w"> </span><span class="m">01</span>:00<span class="w"> </span>-I<span class="w"> </span>lrun<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="w"> </span>-M<span class="w"> </span><span class="s2">&quot;-mxm&quot;</span><span class="w"> </span>./command
</pre></div>
</div>
</section>
</section>
</section>
<section id="compiling-parallel-mpi-hdf5-for-inq">
<h2><span class="section-number">2.3. </span>Compiling Parallel (MPI) HDF5 for INQ<a class="headerlink" href="#compiling-parallel-mpi-hdf5-for-inq" title="Permalink to this heading"></a></h2>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">configure</span><span class="w"> </span><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">parallel</span><span class="w"> </span><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">cxx</span><span class="w"> </span><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">unsupported</span><span class="w"> </span><span class="n">CC</span><span class="o">=</span><span class="n">mpicc</span><span class="w"> </span><span class="n">CXX</span><span class="o">=</span><span class="n">mpic</span><span class="o">++</span><span class="w"> </span><span class="o">--</span><span class="n">prefix</span><span class="o">=</span><span class="p">...</span><span class="n">whatever</span><span class="p">...</span>
</pre></div>
</div>
</section>
<section id="cmake">
<span id="id1"></span><h2><span class="section-number">2.4. </span>CMake<a class="headerlink" href="#cmake" title="Permalink to this heading"></a></h2>
<p>This is a list of cmake options that are relevant for INQ / INQ template</p>
<table class="docutils align-center" id="id2" style="width: 90%">
<caption><span class="caption-text"><cite>cmake</cite> options</span><a class="headerlink" href="#id2" title="Permalink to this table"></a></caption>
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 60%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>option</p></th>
<th class="head"><p>values</p></th>
<th class="head"><p>description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><cite>–fresh</cite></p></td>
<td></td>
<td><p>Run the cmake configuration from scratch, ignoring what’s already in the directory. We recommend you to always add this flag when calling <cite>cmake</cite>, especially when trying different configuration options. (This is only available from CMake 3.24 onwards, if you have a previous version you can get the same result by removing <cite>CMakeCache.txt</cite> and <cite>CMakeFiles</cite>.</p></td>
</tr>
<tr class="row-odd"><td><p><cite>–install-prefix=</cite></p></td>
<td></td>
<td><p>The directory where INQ will be installed after compilation. This must be set and a place where the user is allowed to write.</p></td>
</tr>
<tr class="row-even"><td><p><cite>-DCMAKE_BUILD_TYPE=</cite></p></td>
<td><p><cite>Release</cite> (default), <cite>Debug</cite></p></td>
<td><p>This sets the type of compilation of INQ. <cite>-DCMAKE_BUILD_TYPE=Release</cite> compile with maximum optimization and without debugging code, this is the fastest option that should be used for production runs. <cite>-DCMAKE_BUILD_TYPE=Debug</cite> add extra checks to ensure the code is running correctly, but it makes the code run slower. By default INQ is compiled in ‘Release’ mode.</p></td>
</tr>
<tr class="row-odd"><td><p><cite>-DENABLE_CUDA=yes</cite></p></td>
<td></td>
<td><p>Enable compilation with CUDA. If this is set, INQ will try to run on an Nvidia GPU. Disabled by default.</p></td>
</tr>
<tr class="row-even"><td><p><cite>-DENABLE_NCCL=yes</cite></p></td>
<td></td>
<td><p>(Experimental) Use the NVIDIA NCCL library for communication. Disabled by default.</p></td>
</tr>
</tbody>
</table>
<p>Cmake is requirement to build INQ (even if hidden behind a <cite>./configure</cite> script). Cmake handles INQ’s dependencies, some of which are pretty new (in particular CUDA 11).</p>
<p>In general Cmake must be newer than the libraries it handles. Therefore a recent version of Cmake (e.g. above 3.16) might be required. For reference Ubuntu 20.04 has cmake 3.16 and Fedora 31 has cmake 3.17.</p>
<p>If your system supports modules, you can</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>module<span class="w"> </span>avail<span class="w"> </span>cmake
module<span class="w"> </span>load<span class="w"> </span>cmake<span class="w"> </span><span class="m">3</span>.17
</pre></div>
</div>
<p>There might be no option other than installing your own (and in your userspace).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wget<span class="w"> </span>https://github.com/Kitware/CMake/releases/download/v3.21.1/cmake-3.21.1-linux-x86_64.sh
sh<span class="w"> </span>./cmake-3.21.1-linux-x86_64.sh<span class="w"> </span>--prefix<span class="o">=</span><span class="nv">$HOME</span><span class="w"> </span>--skip-license
~/bin/cmake<span class="w"> </span>--version
</pre></div>
</div>
<p>The newer version of cmake will be in ~/bin/cmake. If you use the <cite>./configure</cite> script then you have to specify the command used to invoke cmake:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">CMAKE_CMD</span><span class="o">=~/</span><span class="n">bin</span><span class="o">/</span><span class="n">cmake</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">configure</span><span class="w"> </span><span class="p">...</span>
</pre></div>
</div>
<p>For other versions of cmake see <a class="reference external" href="https://cmake.org/download/">https://cmake.org/download/</a></p>
</section>
<section id="boost">
<h2><span class="section-number">2.5. </span>BOOST<a class="headerlink" href="#boost" title="Permalink to this heading"></a></h2>
<section id="install-boost-libraries">
<h3><span class="section-number">2.5.1. </span>Install BOOST libraries<a class="headerlink" href="#install-boost-libraries" title="Permalink to this heading"></a></h3>
<p>From download:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span><span class="w"> </span><span class="o">~/</span><span class="n">Downloads</span>
<span class="n">wget</span><span class="w"> </span><span class="n">https</span><span class="o">:</span><span class="c1">//dl.bintray.com/boostorg/release/1.73.0/source/boost_1_73_0.tar.gz</span>
<span class="n">tar</span><span class="w"> </span><span class="o">-</span><span class="n">zxvf</span><span class="w"> </span><span class="n">boost_1_73_0</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
<span class="n">cd</span><span class="w"> </span><span class="n">boost_1_73_0</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">build</span>
<span class="p">.</span><span class="o">/</span><span class="n">bootstrap</span><span class="p">.</span><span class="n">sh</span>
<span class="p">.</span><span class="o">/</span><span class="n">b2</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">--</span><span class="n">prefix</span><span class="o">=</span><span class="n">$HOME</span><span class="o">/</span><span class="p">.</span><span class="n">local</span>
<span class="o">~/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">b2</span><span class="w"> </span><span class="o">--</span><span class="n">build</span><span class="o">-</span><span class="n">dir</span><span class="o">=/</span><span class="n">tmp</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">boost</span><span class="w"> </span><span class="n">toolset</span><span class="o">=</span><span class="n">gcc</span><span class="w"> </span><span class="n">install</span>
</pre></div>
</div>
<p>Includes will be in <code class="docutils literal notranslate"><span class="pre">~/Downloads/boost_1_73_0/boost</span></code>, library binaries will be in <code class="docutils literal notranslate"><span class="pre">~/Downloads/boost_1_73_0/stage/lib</span></code>.</p>
<p>From GitHub</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>git@github.com:boostorg/boost.git
<span class="nb">cd</span><span class="w"> </span>boost
./bootstrap.sh<span class="w"> </span>--prefix<span class="o">=</span><span class="nv">$HOME</span>/.local
<span class="nb">time</span><span class="w"> </span>./b2<span class="w"> </span>-j<span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="nv">cxxflags</span><span class="o">=</span><span class="s1">&#39;-fPIC -O3&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>bjam.out
<span class="nb">time</span><span class="w"> </span>./b2<span class="w"> </span>install
</pre></div>
</div>
</section>
<section id="install-boost">
<h3><span class="section-number">2.5.2. </span>Install BOOST<a class="headerlink" href="#install-boost" title="Permalink to this heading"></a></h3>
<p>INQ depends on Boost and can use your system installation of Boost.
For example, in Debian, it can be installed as <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt</span> <span class="pre">install</span> <span class="pre">libboost-all-dev</span></code>.</p>
<p>In some HPC systems (e.g. NERSC’s Frontera) the system installation is not well detected by Cmake and using incompatible headers and binaries (e.g. segmentation faults in <code class="docutils literal notranslate"><span class="pre">boost::filesystem::create_directory</span></code>) and the Boost module needs to be loaded even if there is a system version of Boost. (<code class="docutils literal notranslate"><span class="pre">module</span> <span class="pre">load</span> <span class="pre">boost</span></code>).
In some others (e.g. NERSC’s Cori) the system installation of Boost is not recognized by Cmake at all.
In such cases, one might need a manual installation:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">BOOST_VER</span><span class="o">=</span>1_80_0
mkdir<span class="w"> </span>-p<span class="w"> </span><span class="nv">$HOME</span>/soft
<span class="nb">cd</span><span class="w"> </span><span class="nv">$HOME</span>/soft
wget<span class="w"> </span>http://downloads.sourceforge.net/boost/boost_<span class="nv">$BOOST_VER</span>.tar.gz
tar<span class="w"> </span>-zxvf<span class="w"> </span>boost_<span class="nv">$BOOST_VER</span>.tar.gz
<span class="nb">cd</span><span class="w"> </span>boost_<span class="nv">$BOOST_VER</span>

./bootstrap.sh<span class="w"> </span>--prefix<span class="o">=</span><span class="nv">$HOME</span>

./b2<span class="w"> </span>install
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>../configure<span class="w"> </span>...<span class="w"> </span>--pass-thru<span class="w"> </span>-DBOOST_INCLUDE_DIR<span class="o">=</span><span class="nv">$HOME</span>/include
...
<span class="nb">export</span><span class="w"> </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="nv">$HOME</span>/lib:<span class="nv">$LD_LIBRARY_PATH</span><span class="w">  </span><span class="c1"># maybe needed</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="introduction.html" class="btn btn-neutral float-left" title="1. README" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="theory.html" class="btn btn-neutral float-right" title="3. Theory" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2025 Lawrence Livermore National Security, LLC., Xavier Andrade, Alfredo A. Correa.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script> 

</body>
</html>